package servlet.session.cart;

import java.io.IOException;
import java.util.HashMap;

import javax.servlet.RequestDispatcher;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

public class ShoppingCartServlet extends HttpServlet {

	public void doGet(HttpServletRequest request, HttpServletResponse response)
			throws ServletException, IOException {
		doPost(request, response);
	}
	public void doPost(HttpServletRequest request, HttpServletResponse response)
			throws ServletException, IOException {
		//1. 로그인 체크 - Filter로 대체
		HttpSession session = request.getSession();
		String url=null;
			//장바구니 처리
			//1. 요청파라미터 조회
			request.setCharacterEncoding("UTF-8");
			String [] items = request.getParameterValues("items");
			if(items==null){//상품을 선택하지 않고 요청한 경우.
				request.setAttribute("error_message", "상품을 한개 이상 선택하세요");
				url = "/WEB-INF/jsp/cart/list.jsp";
				RequestDispatcher rd = request.getRequestDispatcher(url);
				rd.forward(request, response);
			}else{//장바구니 처리
				//상품들을 장바구니에 담는 작업
				//2. Session에서 Cart 조회||생성(없는 경우)
				HashMap<String, Integer> cart = (HashMap)session.getAttribute("cart");
				if(cart==null){
					cart = new HashMap<String, Integer>();
					session.setAttribute("cart", cart);
				}
				//2-3. Cart에 상품담기
				for(int i = 0; i<items.length; i++){
//					  Cart에 없는 상품인 경우 추가, 있는 상품인 경우 개수 증가
					if(cart.containsKey(items[i])){//있는 상품
						int cnt = cart.get(items[i])+1;
						cart.put(items[i], cnt);
					}else{//없는 상품
						cart.put(items[i], 1);
					}
				}	
				url = "/SimpleLoginCart_WithFilter/redirect?path=/WEB-INF/jsp/cart/show_cart.jsp";
			}//장바구니 처리 if문
//		응답
			response.sendRedirect(url);	
	}
}


























